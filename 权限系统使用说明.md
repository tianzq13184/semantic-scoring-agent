# 权限系统使用说明

## 🎯 功能概述

系统实现了简化的权限系统，支持两个角色：
- **学生（student）**：答题、浏览自己的结果
- **老师（teacher）**：管理、判分、查看所有结果

## 🚀 快速开始

### 1. 初始化数据库和用户

```bash
# 重新创建数据库表（包含 User 表）
python -c "from api.db import Base, engine; Base.metadata.drop_all(engine); Base.metadata.create_all(engine)"

# 运行数据迁移（创建题目和评分标准）
python run_migrations.py

# 初始化用户（创建默认老师和学生）
python init_users.py
```

### 2. 启动服务

**终端 1 - 后端**：
```bash
uvicorn api.main:app --reload --port 8000
```

**终端 2 - 前端**：
```bash
cd ui
streamlit run app.py
```

### 3. 使用系统

1. 打开前端：http://localhost:8501
2. 在侧边栏选择用户登录：
   - **老师**：选择 `teacher001` (张老师)
   - **学生**：选择 `student001` (学生1)
3. 点击"登录"按钮
4. 根据角色使用不同功能

## 📋 功能权限

### 学生功能
- ✅ **评估答案**：可以答题
- ✅ **评估结果列表**：只能看到自己的结果
- ✅ **评估详情**：只能查看自己的详情

### 老师功能
- ✅ **评估答案**：可以答题（用于测试等）
- ✅ **评估结果列表**：可以查看所有学生的结果
- ✅ **评估详情**：可以查看所有详情
- ✅ **教师审核**：可以覆盖评分并添加备注
- ✅ **题目管理**：创建、编辑、删除题目
- ✅ **评分标准管理**：创建、编辑、激活评分标准
- ✅ **用户管理**：创建和管理用户

## 🔐 认证方式

系统使用简化的认证方式：
- **请求头**：`X-User-Token: {user_id}`
- **前端自动添加**：登录后，所有 API 请求会自动包含认证头
- **后端验证**：从请求头获取用户ID，查询数据库验证用户和角色

## 📝 创建新用户

### 通过 API（需要老师权限）

```bash
curl -X POST "http://127.0.0.1:8000/users" \
  -H "X-User-Token: teacher001" \
  -H "Content-Type: application/json" \
  -d '{
    "id": "student002",
    "username": "学生2",
    "role": "student"
  }'
```

### 通过 Python 脚本

```python
from api.db import SessionLocal, User

sess = SessionLocal()
try:
    user = User(id="student002", username="学生2", role="student")
    sess.add(user)
    sess.commit()
    print("用户创建成功")
finally:
    sess.close()
```

## ⚠️ 注意事项

1. **首次使用**：必须先运行 `init_users.py` 创建默认用户
2. **数据库更新**：如果修改了 User 表结构，需要重新创建数据库表
3. **权限检查**：所有 API 接口都已添加权限检查，未登录或权限不足会返回 401/403 错误
4. **学生限制**：学生只能查看自己的评估结果，无法访问管理功能

## 🧪 测试建议

### 测试学生权限
1. 登录 student001
2. 答题
3. 查看结果（应该只能看到自己的）
4. 尝试访问管理功能（应该被拒绝）

### 测试老师权限
1. 登录 teacher001
2. 答题
3. 查看所有结果
4. 判分
5. 管理题目和评分标准

## 📚 相关文档

- `docs/AUTH_IMPLEMENTATION.md` - 实现计划
- `docs/AUTH_QUICK_START.md` - 快速开始指南
- `docs/AUTH_COMPLETE.md` - 完成状态

---

**权限系统已完全实现并可以使用！** 🎉

